/**
 * ðŸ§ª TESTS: ValidaciÃ³n de operaciones de cambio de turno
 * 
 * Estos tests verifican que las REGLAS DURAS del dominio se cumplan.
 * Ver SWAP_RULES.md para la especificaciÃ³n completa.
 */

import { validateSwapOperation, SwapValidationContext } from '../../../src/domain/swaps/validateSwapOperation'

describe('validateSwapOperation - COVER', () => {
  describe('âœ… Casos vÃ¡lidos', () => {
    it('permite COVER cuando from trabaja y to estÃ¡ OFF', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'A': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'B': { shouldWork: false, assignment: null },
        },
      }

      const res = validateSwapOperation('COVER', 'A', 'B', 'DAY', ctx)
      expect(res).toBeNull()
    })

    it('permite COVER cuando from tiene BOTH y to estÃ¡ OFF', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'pedro': { shouldWork: true, assignment: { type: 'BOTH' } },
          'lucia': { shouldWork: false, assignment: null },
        },
      }

      const res = validateSwapOperation('COVER', 'pedro', 'lucia', 'DAY', ctx)
      expect(res).toBeNull()
    })
  })

  describe('âŒ Casos invÃ¡lidos - Regla actualizada: Solo bloquear si trabajan el MISMO turno', () => {
    it('rechaza COVER cuando ambos trabajan el MISMO turno', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'pedro': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      const res = validateSwapOperation('COVER', 'juan', 'pedro', 'DAY', ctx)
      expect(res).toContain('ya trabaja en Turno DAY')
    })

    it('âœ… PERMITE COVER cuando trabajan turnos DIFERENTES (nueva regla flexible)', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'carlos': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'diana': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'NIGHT' } },
        },
      }

      // Diana trabaja Noche, puede cubrir DÃ­a (se convierte en BOTH)
      const res = validateSwapOperation('COVER', 'carlos', 'diana', 'DAY', ctx)
      expect(res).toBeNull()
    })

    it('rechaza COVER cuando to tiene BOTH (ya trabaja ese turno)', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'ana': { shouldWork: true, assignment: { type: 'BOTH' } },
          'luis': { shouldWork: true, assignment: { type: 'BOTH' } },
        },
      }

      const res = validateSwapOperation('COVER', 'ana', 'luis', 'DAY', ctx)
      expect(res).toContain('ambos turnos')
    })

    it('rechaza COVER cuando el cubierto NO trabaja ese dÃ­a', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: false, assignment: null },
          'maria': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      const res = validateSwapOperation('COVER', 'juan', 'maria', 'DAY', ctx)
      expect(res).toContain('no trabaja ese dÃ­a')
    })

    it('rechaza COVER cuando from=to (auto-cobertura)', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      const res = validateSwapOperation('COVER', 'juan', 'juan', 'DAY', ctx)
      expect(res).toContain('dos personas distintas')
    })
  })
})

describe('validateSwapOperation - SWAP', () => {
  describe('âœ… Casos vÃ¡lidos', () => {
    it('permite SWAP cuando trabajan turnos OPUESTOS', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'carlos': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'diana': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'NIGHT' } },
        },
      }

      const res = validateSwapOperation('SWAP', 'carlos', 'diana', 'DAY', ctx)
      expect(res).toBeNull()
    })
  })

  describe('âŒ Casos invÃ¡lidos', () => {
    it('rechaza SWAP cuando ambos trabajan el MISMO turno', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'pedro': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      const res = validateSwapOperation('SWAP', 'juan', 'pedro', 'DAY', ctx)
      expect(res).toContain('no tiene efecto')
    })

    it('rechaza SWAP cuando uno NO trabaja ese dÃ­a', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: false, assignment: null },
          'maria': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'NIGHT' } },
        },
      }

      const res = validateSwapOperation('SWAP', 'juan', 'maria', 'DAY', ctx)
      expect(res).toContain('deben trabajar ese dÃ­a')
    })

    it('rechaza SWAP cuando alguno no tiene assignment', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'carlos': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
          'lucia': { shouldWork: false, assignment: null },
        },
      }

      const res = validateSwapOperation('SWAP', 'carlos', 'lucia', 'DAY', ctx)
      expect(res).not.toBeNull()
    })

    it('rechaza SWAP cuando from=to', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      const res = validateSwapOperation('SWAP', 'juan', 'juan', 'DAY', ctx)
      expect(res).toContain('dos personas distintas')
    })
  })
})

describe('validateSwapOperation - DOUBLE', () => {
  describe('âœ… Casos vÃ¡lidos', () => {
    it('permite DOUBLE cuando to YA trabaja otro turno', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'elena': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        },
      }

      // Elena hace DOUBLE en Noche (ya trabaja DÃ­a)
      const res = validateSwapOperation('DOUBLE', undefined, 'elena', 'NIGHT', ctx)
      expect(res).toBeNull()
    })
  })

  describe('âŒ Casos invÃ¡lidos', () => {
    it('rechaza DOUBLE cuando to estÃ¡ OFF', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'juan': { shouldWork: false, assignment: null },
        },
      }

      const res = validateSwapOperation('DOUBLE', undefined, 'juan', 'DAY', ctx)
      expect(res).toContain('no trabaja')
    })

    it('rechaza DOUBLE cuando to YA trabaja BOTH', () => {
      const ctx: SwapValidationContext = {
        daily: {
          'pedro': { shouldWork: true, assignment: { type: 'BOTH' } },
        },
      }

      const res = validateSwapOperation('DOUBLE', undefined, 'pedro', 'DAY', ctx)
      expect(res).toContain('ya trabaja ambos turnos')
    })
  })
})

describe('Reglas de negocio - Casos integrados', () => {
  it('rechaza COVER si to trabaja BOTH (ya trabaja ese turno)', () => {
    const ctx: SwapValidationContext = {
      daily: {
        'A': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        'C': { shouldWork: true, assignment: { type: 'BOTH' } },
      },
    }

    const res = validateSwapOperation('COVER', 'A', 'C', 'DAY', ctx)
    expect(res).toContain('ambos turnos')
  })

  it('permite COVER vÃ¡lido (OFF â†’ trabajando)', () => {
    const ctx: SwapValidationContext = {
      daily: {
        'A': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        'B': { shouldWork: false, assignment: null },
      },
    }

    const res = validateSwapOperation('COVER', 'A', 'B', 'DAY', ctx)
    expect(res).toBeNull()
  })

  it('rechaza DOUBLE si no trabaja', () => {
    const ctx: SwapValidationContext = {
      daily: {
        'B': { shouldWork: false, assignment: null },
      },
    }

    const res = validateSwapOperation('DOUBLE', undefined, 'B', 'DAY', ctx)
    expect(res).toBeTruthy()
  })

  it('rechaza SWAP si uno no trabaja', () => {
    const ctx: SwapValidationContext = {
      daily: {
        'A': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        'B': { shouldWork: false, assignment: null },
      },
    }

    const res = validateSwapOperation('SWAP', 'A', 'B', 'DAY', ctx)
    expect(res).toBeTruthy()
  })

  it('rechaza SWAP inÃºtil (mismo turno)', () => {
    const ctx: SwapValidationContext = {
      daily: {
        'A': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
        'B': { shouldWork: true, assignment: { type: 'SINGLE', shift: 'DAY' } },
      },
    }

    const res = validateSwapOperation('SWAP', 'A', 'B', 'DAY', ctx)
    expect(res).toBeTruthy()
  })
})
